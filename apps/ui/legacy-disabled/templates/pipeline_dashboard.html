<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto px-4 py-8" x-data="pipelineMonitor()">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-blue-400">🚀 Whis SOAR Pipeline Monitor</h1>
            <p class="text-gray-400 mt-2">Real-time monitoring for lanes 1-4 data pipeline</p>
        </header>

        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Intake Card -->
            <div class="bg-gray-800 rounded-lg p-6 border-l-4" :class="status.green_lights.intake ? 'border-green-400' : 'border-yellow-400'">
                <h3 class="text-xl font-semibold text-blue-300 mb-3">📥 Intake</h3>
                <div class="space-y-2">
                    <p class="text-2xl font-bold" x-text="status.intake.events.toLocaleString()">0</p>
                    <p class="text-sm text-gray-400">Total Events</p>
                    <div class="flex justify-between text-xs">
                        <span>Splunk: <span x-text="status.intake.sources.splunk"></span></span>
                        <span>LC: <span x-text="status.intake.sources.limacharlie"></span></span>
                    </div>
                </div>
            </div>

            <!-- Sanitize Card -->
            <div class="bg-gray-800 rounded-lg p-6 border-l-4" :class="status.green_lights.sanitize ? 'border-green-400' : 'border-yellow-400'">
                <h3 class="text-xl font-semibold text-purple-300 mb-3">🧹 Sanitize</h3>
                <div class="space-y-2">
                    <p class="text-2xl font-bold" x-text="status.sanitize.events.toLocaleString()">0</p>
                    <p class="text-sm text-gray-400">Events Processed</p>
                    <div class="flex justify-between text-xs">
                        <span>Redacted: <span x-text="status.sanitize.redactions"></span></span>
                        <span>Valid: <span x-text="(status.sanitize.validation_rate * 100).toFixed(1)">0</span>%</span>
                    </div>
                </div>
            </div>

            <!-- Curate Card -->
            <div class="bg-gray-800 rounded-lg p-6 border-l-4" :class="status.green_lights.curate ? 'border-green-400' : 'border-yellow-400'">
                <h3 class="text-xl font-semibold text-green-300 mb-3">🎓 Curate</h3>
                <div class="space-y-2">
                    <p class="text-2xl font-bold" x-text="status.curate.llm_pairs.toLocaleString()">0</p>
                    <p class="text-sm text-gray-400">LLM Training Pairs</p>
                    <div class="flex justify-between text-xs">
                        <span>RAG Chunks: <span x-text="status.curate.rag_chunks"></span></span>
                        <span>Files: <span x-text="status.curate.files"></span></span>
                    </div>
                </div>
            </div>

            <!-- Security Gates Card -->
            <div class="bg-gray-800 rounded-lg p-6 border-l-4" :class="status.security_gates.status === 'PASS' ? 'border-green-400' : 'border-red-400'">
                <h3 class="text-xl font-semibold text-red-300 mb-3">🛡️ Security</h3>
                <div class="space-y-2">
                    <p class="text-2xl font-bold" x-text="status.security_gates.status">UNKNOWN</p>
                    <p class="text-sm text-gray-400">Gate Status</p>
                    <div class="flex justify-between text-xs">
                        <span>Scans: <span x-text="status.security_gates.validation_passes"></span></span>
                        <span>Secrets: <span x-text="status.security_gates.secrets_detected"></span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Green Light Status -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h3 class="text-xl font-semibold mb-4">🚦 Green Light Status</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-3xl mb-2" x-text="status.green_lights.intake ? '🟢' : '🟡'">🟡</div>
                    <p class="text-sm">Intake</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl mb-2" x-text="status.green_lights.sanitize ? '🟢' : '🟡'">🟡</div>
                    <p class="text-sm">Sanitize</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl mb-2" x-text="status.green_lights.curate ? '🟢' : '🟡'">🟡</div>
                    <p class="text-sm">Curate</p>
                </div>
                <div class="text-center">
                    <div class="text-3xl mb-2" x-text="status.green_lights.overall ? '🟢' : '🟡'">🟡</div>
                    <p class="text-sm font-bold">Overall</p>
                </div>
            </div>
        </div>

        <!-- Real-time Logs -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h3 class="text-xl font-semibold mb-4">📊 Real-time Activity</h3>
            <div class="bg-gray-900 rounded p-4 font-mono text-sm h-48 overflow-y-auto" id="logs">
                <div class="text-green-400" x-show="connected">● Connected to pipeline monitor</div>
                <div class="text-red-400" x-show="!connected">● Disconnected from pipeline monitor</div>
                <div class="text-gray-400 mt-2">Last update: <span x-text="lastUpdate">Never</span></div>
            </div>
        </div>
    </div>

    <script>
        function pipelineMonitor() {
            return {
                status: {
                    intake: { events: 0, sources: { splunk: 0, limacharlie: 0 } },
                    sanitize: { events: 0, redactions: 0, validation_rate: 0 },
                    curate: { llm_pairs: 0, rag_chunks: 0, files: 0 },
                    security_gates: { status: 'UNKNOWN', validation_passes: 0, secrets_detected: 0 },
                    green_lights: { intake: false, sanitize: false, curate: false, overall: false }
                },
                connected: false,
                lastUpdate: 'Never',
                ws: null,

                init() {
                    this.connectWebSocket();
                    this.fetchStatus();
                    setInterval(() => this.fetchStatus(), 10000); // Fallback polling
                },

                connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    this.ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
                    
                    this.ws.onopen = () => {
                        this.connected = true;
                        console.log('WebSocket connected');
                    };
                    
                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        if (data.type === 'status_update') {
                            this.status = data.data;
                            this.lastUpdate = new Date().toLocaleTimeString();
                        }
                    };
                    
                    this.ws.onclose = () => {
                        this.connected = false;
                        setTimeout(() => this.connectWebSocket(), 5000);
                    };
                },

                async fetchStatus() {
                    try {
                        const response = await fetch('/api/pipeline/status');
                        const data = await response.json();
                        this.status = data;
                        this.lastUpdate = new Date().toLocaleTimeString();
                    } catch (error) {
                        console.error('Error fetching status:', error);
                    }
                }
            };
        }
    </script>
</body>
</html>